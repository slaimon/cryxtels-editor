<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./base.css">
    <title>Crystal Pixels Playground</title>
    <script type="importmap">
        {
          "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/",
            "o3dv": "https://cdn.jsdelivr.net/npm/online-3d-viewer@0.13.0/+esm"
          }
        }
      </script>
</head>
<body>
    <div id="main" class="main">
        <div class="editor_wrapper">
            <div class="editor_menubar">
                <div class="editor_menu dropdown_menu">
                    <button id="load_btn" class="editor_menubtn dropdown_btn">
                        Load
                        <img src="arrowhead.svg" class="dropdown_icon"></img>
                    </button>
                    <div id="load_dropdown" class="dropdown_content">
                        <ul>
                            <li id="pixelLoader" class="dropdown_option">Pixel...</li>
                            <li id="modelLoader" class="dropdown_option">Model...</li>
                        </ul>
                    </div>
                </div>
                <div class="editor_menu dropdown_menu">
                    <button id="save_btn" class="editor_menubtn dropdown_btn">
                        Save
                        <img src="arrowhead.svg" class="dropdown_icon"></imf>
                    </button>
                    <div id="save_dropdown" class="dropdown_content">
                        <p class="dropdown_option">Compile and Copy</p>
                        <p class="dropdown_option">Export .OBJ Mesh</p>
                    </div>
                </div>
                <div class="editor_menu">
                    <button id="reset_btn" class="editor_menubtn">Reset Camera</button>
                </div>
            </div>
            <div class="editor_body">
                <div class="editor_code">
                    <textarea id="textarea" class="code_textarea"></textarea>
                </div>
            </div>
            <div class="editor_footer">
                <div class="editor_footer-left">
                    <button id="editor_btn" class="editor_btn editor_run">Run</button>
                </div>
                <div class="editor_footer-right">
                    <div class="editor_console">
                        <ul class="editor_console-logs"></ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="viewport" class="viewer_wrapper"></div>
    </div>
    <div id="meshSelectionPopup" class="popup">
        <div class="popup_content">
            <h2>Select a mesh...</h2>
            <hr>
            <p>ciao io sn simone</p>
        </div>
    </div>
</body>
<script type="module">
    import { parse } from "./parse.js"
    import { Pixel } from "./pixel.js"
    import { createThreeLineMesh } from "./converter.js"
    import { initializeViewer } from "./viewer.js"
    import { setPopup, clickHandler } from "./ui.js"

    window.addEventListener("click", event => clickHandler(event));
    setPopup("pixelLoader", "meshSelectionPopup");

    const viewport = document.getElementById("viewport");
    const viewer = initializeViewer(viewport);
    const textarea = document.getElementById("textarea");
    const editor_btn = document.getElementById("editor_btn");
    function runDefinition() {
        let environment = {
            "%d": Math.floor(Math.random() * 500)
        }
        let pixel = parse(textarea.value, environment);
        pixel.addShip();
        let objstring = pixel.toObjString();
        console.log(objstring);
        const objFile = new File([objstring], `${pixel.name}.obj`);
        viewer.LoadModelFromFileList([objFile]);
    }

    editor_btn.addEventListener("click", runDefinition);
</script>
</html>